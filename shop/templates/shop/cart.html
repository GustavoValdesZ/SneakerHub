{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Carrito de Compras - SneakerHub{% endblock %}

{% block content %}
<section class="cart-section">
    <div class="container">
        <h1 style="font-size: 3rem; margin-bottom: 2rem;">üõí Tu Carrito</h1>

        {% if cart_items %}
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item" data-item-id="{{ item.id }}">
                <div>
                    {% if item.product.image %}
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="cart-item-image">
                    {% else %}
                    <div class="cart-item-image"
                        style="display: flex; align-items: center; justify-content: center; font-size: 3rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));">
                        üëü
                    </div>
                    {% endif %}
                </div>

                <div class="cart-item-details">
                    <h3>{{ item.product.name }}</h3>
                    <p style="color: var(--gray); margin: 0.5rem 0;">{{ item.product.brand }} - Talla: {{ item.size }}
                    </p>
                    <p class="cart-item-price">${{ item.product.price }}</p>
                </div>

                <div style="text-align: right;">
                    <div class="quantity-controls">
                        <button class="quantity-btn"
                            onclick="updateQuantity({{ item.id }}, {{ item.quantity }} - 1)">-</button>
                        <span style="font-size: 1.2rem; font-weight: 600; min-width: 30px; text-align: center;">{{
                            item.quantity }}</span>
                        <button class="quantity-btn"
                            onclick="updateQuantity({{ item.id }}, {{ item.quantity }} + 1)">+</button>
                    </div>
                    <p style="margin-top: 1rem; font-size: 1.5rem; font-weight: 700;">
                        Subtotal: $<span class="item-subtotal">{{ item.subtotal }}</span>
                    </p>
                    <button class="btn btn-secondary" onclick="removeItem({{ item.id }})"
                        style="margin-top: 1rem; padding: 0.5rem 1rem;">
                        üóëÔ∏è Eliminar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total">${{ total }}</span>
            </div>
            <button class="btn"
                style="width: 100%; background: white; color: var(--primary); font-size: 1.3rem; padding: 1.5rem;">
                ‚ú® Proceder al Pago
            </button>
            <a href="{% url 'shop:home' %}" class="btn btn-secondary"
                style="width: 100%; margin-top: 1rem; text-align: center;">
                ‚Üê Seguir Comprando
            </a>
        </div>
        {% else %}
        <div class="empty-state">
            <h2 style="font-size: 2.5rem;">üõçÔ∏è Tu carrito est√° vac√≠o</h2>
            <p style="color: var(--gray); font-size: 1.2rem; margin: 1rem 0;">¬°Descubre nuestros incre√≠bles productos!
            </p>
            <a href="{% url 'shop:home' %}" class="btn btn-primary" style="margin-top: 2rem; font-size: 1.2rem;">
                Ver Cat√°logo
            </a>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) {
            removeItem(itemId);
            return;
        }

        const formData = new FormData();
        formData.append('quantity', newQuantity);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch(`/cart/update/${itemId}/`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Error updating cart:', error);
        }
    }

    async function removeItem(itemId) {
        if (!confirm('¬øEst√°s seguro de eliminar este producto?')) {
            return;
        }

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch(`/cart/remove/${itemId}/`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('Error removing item:', error);
        }
    }
</script>
{% endblock %}